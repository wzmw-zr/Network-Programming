# TCP可靠传输

TCP的任务是在IP层不可靠的、尽力而为服务的基础上建立一种可靠数据传输服务。**TCP提供的可靠数据传输服务保证接受方进程从缓存区读出的字节流与发送方发出的字节流完全一致。**

TCP使用了**==校验、序号、确认和重传机制==**来达到可靠传输的目的。

## 一、序号

**TCP连接传送的数据流中每个字节都编上一个序号，TCP首部的序号字段表示本报文段所发送数据的第一个序号。**

> 序号建立在传送的字节流上，而不建立在报文段上。



## 二、确认号

**TCP首部的确认号是期望收到对方的下一个报文段的数据的第一个字节的序号。**

发送方会缓存那些已经发送但是没有收到确认的报文段，以便在需要时重传。

**TCP默认使用累计确认，即只确认数据流中至第一个丢失字节为止的字节。**即使后面的报文段来了，对方接受了，但是依然是请求丢失的那个报文段。



## 三、重传

会导致TCP对报文段进行重传的两种事件：**超时，冗余ACK。**

### 1.超时

TCP每发送一个报文段，就要对这个报文段设置一次计时器。**计时器设置的重传时间到期但还没有收到确认时，就要重传这个报文段。**

由于TCP下层是一个互联网环境，IP数据报所选择的路由变化很大，因而传输层的往返时延方差很大。**为了计算超时计时器的重传时间，TCP采用一种自适应算法。**

TCP会记录一个报文的发出时间和收到相应确认的时间，这两个时间的时间差被称为**报文段的往返时间 (RTT, Round-Trip Time)**。TCP保留了一个**加权平均往返时间$RTT_s$。超时计时器设置的超时重传时间(RTO, Retransmission Time-Out)应略大于$RTT_s$。**



### 2.冗余ACK

超时重传的缺点在于超时重传周期太长，并且一个丢失的包之后的包都被接受到了，那么发送方就可以**在超时事件发生之前通过注意这些冗余ACK来检测丢包的情况。**

**冗余ACK就是再次确认某个报文段的ACK，而发送方之前已经收到过该报文段的确认。**

如果发送方收到3次冗余ACK，那么就进行重传。