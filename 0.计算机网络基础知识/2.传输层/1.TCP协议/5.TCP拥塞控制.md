# TCP拥塞控制

拥塞控制，是指防止过多的数据注入网络，保证网络中的路由器或者链路不至于过载。

**拥塞控制中的拥塞窗口`cwnd`受到网络状况的影响，其大小与网络带宽和时延密切相关。**



## 一、拥塞控制的指导思想

1. **一个丢失的报文段意味着拥塞，丢包就应该减小发送端的发送速率。**
2. **一个确认的报文段表示网络正在向接受方交付报文段，因此，当收到对之前的报文段的ACK之后，应该增加发送方速率。**
3. **带宽探测**



## 二、拥塞控制与流量控制的区别

**拥塞控制：让网络能够承受现有的网络负荷**，是一个全局性的过程，涉及所有的主机、路由器以及与降低网络传输性能有关的所有因素。

**流量控制：是指点对点的通信量的控制**，即接收端控制发送端，它要做的就是抑制发送端发送数据的速率，以便接收端来得及接收。

发送方在确定报发送报文段的速率时，既要根据接受方的接收能力，也要从全局考虑不要使网络发生拥塞。因此，TCP协议要求发送方维护以下两个窗口：

1. **接收窗口`rwnd`：** **接收方根据目前接收缓存大小许诺的最新窗口值，反映接受方的容量。**由接受方根据其放在TCP报文段首部的窗口字段通知发送方。**发送方在发送时还要考虑到已经发送但是还没有收到确认的报文段。**
2. **拥塞窗口`cwnd`：** **发送方根据自己估算的网络拥塞程度而设置的窗口值，反映当前的网络容量。**只要网络未出现阻塞，拥塞窗口就可以大一些，以便将更多的分组发送出去。但是只要网络出现阻塞，拥塞窗口就应当减少一些，以减少注入网络的分组数。



**发送窗口的上限值应当设置为接收窗口和拥塞窗口中较小的那一个。**

**==注意三种窗口之间的关系。==**



## 三、拥塞控制的四种算法

### 1.慢开始与拥塞避免算法

**==慢开始与拥塞避免算法用于处理TCP报文段开始发送、发生超时的情况。==**

#### (1)慢开始算法

当TCP刚刚连接好并开始发送TCP报文段时，先令拥塞窗口`cwnd=1`，即一个最大报文段长度`MSS`。**==每收到一个新的报文段的确认之后，将`cwnd`加1 ，即增加一个`MSS`。==**

在慢开始算法中，**每经过一个传输轮次(即往返时延`RTT`)，拥塞窗口`cwnd`就会加倍**，即`cwnd`的大小按照指数式增长。这样，**==慢开始算法一直将拥塞窗口增加到规定的慢开始门限`ssthresh`(阈值)，然后改用拥塞避免算法。==**

**==阈值的作用：判断何时进入拥塞避免状态。==**一旦拥塞窗口超过阈值，就不能按照指数级别增长了，需要试探进行。**==阈值就相当于对网络状态的一个评估标准，在标准之内，可以快速增加拥塞窗口，但是一旦超过界限，就要缓慢进行。==**



#### (2)拥塞避免算法

当慢开始算法中的拥塞窗口大于等于阈值时，就不能让拥塞窗口继续指数增大了，需要进行试探：**发送端的拥塞窗口每经过一个往返时延`RTT`就增加一个`MSS`，使`cwnd`按线性规律缓慢增长。**

一旦出现超时，意味着网络阻塞，不论是在什么阶段，需要将阈值变为当前阻塞窗口大小的一半，**这样可以比较保险地试探网络状态。**同时拥塞窗口`cwnd`设置为1,执行慢开始算法。**==将拥塞窗口设置为1是为了迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够的时间把队列中积压的分组处理完。==**



### 2.快重传和快恢复算法

**快重传和快恢复用于处理连续出现3次冗余`ACK`的情况。**此时意味着网络略微拥塞，但是状况还可以，不需要那么激进地减少分组数。

#### (1)快重传算法

**快重传技术使用了冗余`ACK`来检测丢包的发生。同样，冗余`ACK`也用于网络拥塞的检测**，因为丢包就意味着网络可能出现阻塞。快重传并非取消计时器，而是在某些情况下可以更早地重传丢失的报文段。

当发送方连续收到3个重复的`ACK`报文时，直接重传对方尚未收到的报文段，而不必等待那个报文段设置的重传计时器超时。



#### (2)快恢复算法

当发送端收到连续3个冗余`ACK`时，就执行快重传、快恢复算法。将慢开始门限`ssthresh`(阈值)设置为拥塞时发送方的拥塞窗口的一半。然后拥塞窗口`cwnd`也是变为原来的一半，之后执行拥塞避免算法，使拥塞窗口缓慢地线性增大。由于恢复不是从1开始的，所以称作快恢复算法。



