# 路由选择协议与路由选择算法

## 一、自治系统(Autonomous System)

自治系统是单一技术管理下的一组路由器，这些路由器使用一种一种AS内部的路由选择协议和共同的度量来确定分组在该AS内的路由，同时还使用一种AS之间的路由选择协议来确定分组在AS之间的路由。

**一个自治系统的所有路由器在本自治系统内都必须是连通的。**



## 二、域内路由与域间路由

**自治系统内部的路由选择称为域内路由选择，自治系统之间的路由选择称为域间路由选择。**

有两大类路由选择协议：内部网关协议IGP，外部网关协议EGP。

### 1.内部网关协议

内部网关协议即一个**自治系统内部使用的路由选择协议**，它**与互联网中其他自治系统选用什么路由选择协议无关。**如RIP，OSPF协议。

### 2.外部网关协议

若源站和目的站处于不同的自治系统中，当数据报传到自治系统边界时(两个自治系统可能使用不同IGP)，就需要使用外部网关协议将数据报从一个自治系统传送到另一个自治系统。

**每个自治系统中都会有路由器同时运行本自治系统内部的路由选择协议，和自治系统之间的路由选择协议。**



## 三、内部网关协议

### 1.路由信息协议(RIP)

路由信息协议是一种**基于距离向量算法**的路由选择协议，最大的有点就是简单。

RIP是应用层协议，它使用UDP传送数据，端口是520。RIP选择的路径不一定是时间最短的，但是一定是具有最少路由器的路径。

#### (1)RIP的基本概念与特点

1. **距离向量**：网络中每个**路由器都要维护从它自身到其他每个目的网络的距离记录**，称为距离向量。
2. **距离：**距离也称跳数，规定从一个路由器到直接连接网络的距离为1,每经过一个路由器，距离就加1.
3. RIP优先选择跳数较少的路由。
4. RIP仅和相邻路由器交换信息，并且交换的信息是当前路由器知道的全部信息，即路由表。
5. RIP每隔30s交换信息。
6. RIP限制最大跳数为15，因此，距离等于16时，表示网络不可达。
7. 如果180s还没有收到相邻路由器的更新路由表，那么将相邻路由器置为不可达，跳数置为16。

#### (2)距离向量算法

1. **从相邻的 X 路由器接收发送过来的 RIP（Routing Information Protocol） 报文，将该 RIP 报文中的下一跳地址修改为 X，且跳数增加 1**
2. 对每个项目执行如下步骤：
   a.**若原路由表没有 RIP 中的目的网络 N，直接添加到原路由表中**
   b.**若原路由表中有 RIP 中的目的网络 N，但下一跳地址不是 X ，选择跳数少的替换。如果两者跳数一样，则保留原路由表的项。**
   c.**若原路由表中有 RIP 中的目的网络 N，且下一跳地址是 X，使用收到的项替换**
   **若超过 180s （RIP 默认 180s）还没有收到相邻路由器的更新路由表，则相邻路由器置为不可达，跳数为 16**

#### (3)RIP的优缺点

RIP的最大优点就是实现简单，开销小，收敛过程较快。

RIP的缺点如下：

+ RIP限制了网络的规模，最大跳数为16。
+ 路由器之间交换的是完整的路由表，因此网络规模越大，开销越大。
+ 坏消息传得慢。



### 2.开放最短路径优先协议—OSPF

开放式最短路径优先协议OSPF**基于分布式链路状态路由算法**，也是内部网关协议的一种。

**OSPF协议是网络层协议，直接使用IP数据报传送。**

####  (1)OSPF协议的基本特点

1. OSPF**向本自治系统中的所有路由器发送信息**，这里使用的方法是**洪泛法。**
2. 发送的信息是与本路由器相邻的所有路由器的链路状态，**这只是路由器所知道的部分信息。 ** **链路状态说明本路由器和哪些路由器相邻及链路的度量。**
3. **只有当链路状态发生变化时，路由器才使用洪泛法向所有路由器发送此信息。**并且更新过程收敛快，不会出现坏消息传得慢的问题。
4. OSPF协议可以自定义度量，**并且如果存在多条相同代价的路径，可以实现负载均衡。**



#### (2)OSPF协议的基本原理

OSPF协议最终都可以建立一个**链路状态数据库，这个数据库实际上就是全网的拓扑结构图**，每个路由器**使用Dijkstra最短路径算法计算从自己到各个目的网络的最短路径，以此构造路由表。**

虽然OSPF协议可以用于很大的区域，但是我们依旧可以**将一个自治系统划分为若干个更小的范围，称为区域。**这样减少了网络上的通信量。**主干区域处于上层，负责连通其他下层区域，并且还连通其他自治域。**



#### (3)OSPF的五种分组类型

1. 问候分组，用来**发现和维持临站的可达性**。**通常，每隔10s，每两个相邻路由器要交换一次问候分组。**
2. 数据库描述分组，向临站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
3. 链路状态请求分组，向对方请求发送某些链路状态项目的详细信息。
4. 链路状态更新分组，用洪泛法向全网更新链路状态。
5. 链路状态确定分组，对链路状态更新分组进行确认。



## 三、外部网关协议

### 1.边界网关协议—BGP

**BGP只能力求寻找到一条能够到达目的网络并且比较好的路由，而非最佳路由**。自治系统中需要选出一个或者多个路由器作为**BGP发言人，这些路由器要同时运行内部网关协议和外部网关协议。**

**BGP协议是应用层协议，基于TCP，采用路径向量路由选择算法。**

**在刚开始运行时，BGP和临站交换整个路由表，之后只需要在发生变化时更新有变化的部分。**

BGP协议的四种报文：

1. 打开报文：用于与相邻的另一个BGP发言人建立关系。
2. 更新报文：用于发送某一路由的信息，以及列出要撤销的多条路由。
3. 保活报文：要来确认打开报文并周期性地证实临站关系。
4. 通知报文：用于发送检测到的差错。